<template>
  <action-header title="기타소득자료입력" :buttonDelete="false" :buttonSearch="false" :buttonPrint="false" :buttonSave="false" />
  <div id="pa-720" class="page-content">
    <div :class="{ 'ele-opacity': !compareForm() }">
      <a-spin :spinning="loadingIncomeProcessExtras || isFirstRun" size="large">
        <DxDataGrid :show-row-lines="true" :hoverStateEnabled="true" :data-source="dataSource" :show-borders="true"
          :allow-column-reordering="move_column" key-expr="globalYear" :allow-column-resizing="colomn_resize"
          :column-auto-width="true">
          <DxScrolling mode="standard" show-scrollbar="always" />
          <DxColumn :caption="processKeyPA720.processKey.imputedYear + '귀속월'" cell-template="imputed-year" />
          <template #imputed-year>
            <span>지급연월 </span>
          </template>
          <DxColumn caption="01" width="100px" cell-template="imputed-month1" :cssClass="customColumnClass(1)"
            alignment="center" />
          <template #imputed-month1="{ data }">
            <colorful-badge v-if="data.data.month_1" :value="data.data.month_1?.status"
              :year="data.data.month_1?.paymentYear" :month="data.data.month_1?.paymentMonth"
              @click="showDetailSelected(data.data.month_1)" />
            <div v-else @click="onAddMonth(1)" :class="{ disabled: disableAddMonth(1) }">[+]</div>
          </template>
          <DxColumn caption="02" width="100px" cell-template="imputed-month2" :cssClass="customColumnClass(2)"
            alignment="center" />
          <template #imputed-month2="{ data }">
            <colorful-badge v-if="data.data.month_2" :value="data.data.month_2?.status"
              :year="data.data.month_2?.paymentYear" :month="data.data.month_2?.paymentMonth"
              @click="showDetailSelected(data.data.month_2)" />
            <div v-else @click="onAddMonth(2)" :class="{ disabled: disableAddMonth(2) }">[+]</div>
          </template>
          <DxColumn caption="03" width="100px" cell-template="imputed-month3" :cssClass="customColumnClass(3)"
            alignment="center" />
          <template #imputed-month3="{ data }">
            <colorful-badge v-if="data.data.month_3" :value="data.data.month_3?.status"
              :year="data.data.month_3?.paymentYear" :month="data.data.month_3?.paymentMonth"
              @click="showDetailSelected(data.data.month_3)" />
            <div v-else @click="onAddMonth(3)" :class="{ disabled: disableAddMonth(3) }">[+]</div>
          </template>
          <DxColumn caption="04" width="100px" cell-template="imputed-month4" :cssClass="customColumnClass(4)"
            alignment="center" />
          <template #imputed-month4="{ data }">
            <colorful-badge v-if="data.data.month_4" :value="data.data.month_4?.status"
              :year="data.data.month_4?.paymentYear" :month="data.data.month_4?.paymentMonth"
              @click="showDetailSelected(data.data.month_4)" />
            <div v-else @click="onAddMonth(4)" :class="{ disabled: disableAddMonth(4) }">[+]</div>
          </template>
          <DxColumn caption="05" width="100px" cell-template="imputed-month5" :cssClass="customColumnClass(5)"
            alignment="center" />
          <template #imputed-month5="{ data }">
            <colorful-badge v-if="data.data.month_5" :value="data.data.month_5?.status"
              :year="data.data.month_5?.paymentYear" :month="data.data.month_5?.paymentMonth"
              @click="showDetailSelected(data.data.month_5)" />
            <div v-else @click="onAddMonth(5)" :class="{ disabled: disableAddMonth(5) }">[+]</div>
          </template>
          <DxColumn caption="06" width="100px" cell-template="imputed-month6" :cssClass="customColumnClass(6)"
            alignment="center" />
          <template #imputed-month6="{ data }">
            <colorful-badge v-if="data.data.month_6" :value="data.data.month_6?.status"
              :year="data.data.month_6?.paymentYear" :month="data.data.month_6?.paymentMonth"
              @click="showDetailSelected(data.data.month_6)" />
            <div v-else @click="onAddMonth(6)" :class="{ disabled: disableAddMonth(6) }">[+]</div>
          </template>
          <DxColumn caption="07" width="100px" cell-template="imputed-month7" :cssClass="customColumnClass(7)"
            alignment="center" />
          <template #imputed-month7="{ data }">
            <colorful-badge v-if="data.data.month_7" :value="data.data.month_7?.status"
              :year="data.data.month_7?.paymentYear" :month="data.data.month_7?.paymentMonth"
              @click="showDetailSelected(data.data.month_7)" />
            <div v-else @click="onAddMonth(7)" :class="{ disabled: disableAddMonth(7) }">[+]</div>
          </template>
          <DxColumn caption="08" width="100px" cell-template="imputed-month8" :cssClass="customColumnClass(8)"
            alignment="center" />
          <template #imputed-month8="{ data }">
            <colorful-badge v-if="data.data.month_8" :value="data.data.month_8?.status"
              :year="data.data.month_8?.paymentYear" :month="data.data.month_8?.paymentMonth"
              @click="showDetailSelected(data.data.month_8)" />
            <div v-else @click="onAddMonth(8)" :class="{ disabled: disableAddMonth(8) }">[+]</div>
          </template>
          <DxColumn caption="09" width="100px" cell-template="imputed-month9" :cssClass="customColumnClass(9)"
            alignment="center" />
          <template #imputed-month9="{ data }">
            <colorful-badge v-if="data.data.month_9" :value="data.data.month_9?.status"
              :year="data.data.month_9?.paymentYear" :month="data.data.month_9?.paymentMonth"
              @click="showDetailSelected(data.data.month_9)" />
            <div v-else @click="onAddMonth(9)" :class="{ disabled: disableAddMonth(9) }">[+]</div>
          </template>
          <DxColumn caption="10" width="100px" cell-template="imputed-month10" :cssClass="customColumnClass(10)"
            alignment="center" />
          <template #imputed-month10="{ data }">
            <colorful-badge v-if="data.data.month_10" :value="data.data.month_10?.status"
              :year="data.data.month_10?.paymentYear" :month="data.data.month_10?.paymentMonth"
              @click="showDetailSelected(data.data.month_10)" />
            <div v-else @click="onAddMonth(10)" :class="{ disabled: disableAddMonth(10) }">[+]</div>
          </template>
          <DxColumn caption="11" width="100px" cell-template="imputed-month11" :cssClass="customColumnClass(11)"
            alignment="center" />
          <template #imputed-month11="{ data }">
            <colorful-badge v-if="data.data.month_11" :value="data.data.month_11?.status"
              :year="data.data.month_11?.paymentYear" :month="data.data.month_11?.paymentMonth"
              @click="showDetailSelected(data.data.month_11)" />
            <div v-else @click="onAddMonth(11)" :class="{ disabled: disableAddMonth(11) }">[+]</div>
          </template>
          <DxColumn caption="12" width="100px" cell-template="imputed-month12" :cssClass="customColumnClass(12)"
            alignment="center" />
          <template #imputed-month12="{ data }">
            <colorful-badge v-if="data.data.month_12" :value="data.data.month_12?.status"
              :year="data.data.month_12?.paymentYear" :month="data.data.month_12?.paymentMonth"
              @click="showDetailSelected(data.data.month_12)" />
            <div v-else @click="onAddMonth(12)" :class="{ disabled: disableAddMonth(12) }">[+]</div>
          </template>
          <DxMasterDetail :enabled="true" template="row-detail" />
          <template #row-detail>
            <div class="table-detail">
              <DxDataGrid key-expr="id" :data-source="incomeExtras" :show-borders="false" :column-auto-width="true"
                :allow-column-reordering="move_column" :show-column-headers="false"
                :allow-column-resizing="colomn_resize">
                <DxColumn :caption="globalYear + ' 귀속월'" cell-template="col-first" data-type="string" />
                <template #col-first="{ data }">
                  <b>{{ data.data.name }}</b><br />
                </template>
                <DxColumn caption="1" width="100px" cell-template="month-1" alignment="right"
                  :cssClass="customColumnClass(1)" />
                <template #month-1="{ data }">
                  <div class="hover-underlined" @click="showDetailSelected(data.data.month1)" v-if="data.data.month1">
                    {{ data.data.month1.value }}
                  </div>
                </template>
                <DxColumn caption="2" width="100px" cell-template="month-2" alignment="right"
                  :cssClass="customColumnClass(2)" />
                <template #month-2="{ data }">
                  <div class="hover-underlined" @click="showDetailSelected(data.data.month2)" v-if="data.data.month2">
                    {{ data.data.month2.value }}
                  </div>
                </template>
                <DxColumn caption="3" width="100px" cell-template="month-3" alignment="right"
                  :cssClass="customColumnClass(3)" />
                <template #month-3="{ data }">
                  <div class="hover-underlined" @click="showDetailSelected(data.data.month3)" v-if="data.data.month3">
                    {{ data.data.month3.value }}
                  </div>
                </template>
                <DxColumn caption="4" width="100px" cell-template="month-4" alignment="right"
                  :cssClass="customColumnClass(4)" />
                <template #month-4="{ data }">
                  <div class="hover-underlined" @click="showDetailSelected(data.data.month4)" v-if="data.data.month4">
                    {{ data.data.month4.value }}
                  </div>
                </template>
                <DxColumn caption="5" width="100px" cell-template="month-5" alignment="right"
                  :cssClass="customColumnClass(5)" />
                <template #month-5="{ data }">
                  <div class="hover-underlined" @click="showDetailSelected(data.data.month5)" v-if="data.data.month5">
                    {{ data.data.month5.value }}
                  </div>
                </template>
                <DxColumn caption="6" width="100px" cell-template="month-6" alignment="right"
                  :cssClass="customColumnClass(6)" />
                <template #month-6="{ data }">
                  <div class="hover-underlined" @click="showDetailSelected(data.data.month6)" v-if="data.data.month6">
                    {{ data.data.month6.value }}
                  </div>
                </template>
                <DxColumn caption="7" width="100px" cell-template="month-7" alignment="right"
                  :cssClass="customColumnClass(7)" />
                <template #month-7="{ data }">
                  <div class="hover-underlined" @click="showDetailSelected(data.data.month7)" v-if="data.data.month7">
                    {{ data.data.month7.value }}
                  </div>
                </template>
                <DxColumn caption="8" width="100px" cell-template="month-8" alignment="right"
                  :cssClass="customColumnClass(8)" />
                <template #month-8="{ data }">
                  <div class="hover-underlined" @click="showDetailSelected(data.data.month8)" v-if="data.data.month8">
                    {{ data.data.month8.value }}
                  </div>
                </template>
                <DxColumn caption="9" width="100px" cell-template="month-9" alignment="right"
                  :cssClass="customColumnClass(9)" />
                <template #month-9="{ data }">
                  <div class="hover-underlined" @click="showDetailSelected(data.data.month9)" v-if="data.data.month9">
                    {{ data.data.month9.value }}
                  </div>
                </template>
                <DxColumn caption="10" width="100px" cell-template="month-10" alignment="right"
                  :cssClass="customColumnClass(10)" />
                <template #month-10="{ data }">
                  <div class="hover-underlined" @click="showDetailSelected(data.data.month10)" v-if="data.data.month10">
                    {{ data.data.month10.value }}
                  </div>
                </template>
                <DxColumn caption="11" width="100px" cell-template="month-11" alignment="right"
                  :cssClass="customColumnClass(11)" />
                <template #month-11="{ data }">
                  <div class="hover-underlined" @click="showDetailSelected(data.data.month11)" v-if="data.data.month11">
                    {{ data.data.month11.value }}
                  </div>
                </template>
                <DxColumn caption="12" width="100px" cell-template="month-12" alignment="right"
                  :cssClass="customColumnClass(12)" />
                <template #month-12="{ data }">
                  <div class="hover-underlined" @click="showDetailSelected(data.data.month12)" v-if="data.data.month12">
                    {{ data.data.month12.value }}
                  </div>
                </template>
              </DxDataGrid>
            </div>
          </template>
        </DxDataGrid>
      </a-spin>
    </div>

    <a-row :class="{ 'ele-opacity': !compareForm() }"
      style="border: 1px solid #d7d7d7; padding: 10px; margin-top: 10px; justify-content: space-between">
      <a-col>
        <DxButton :text="'귀 ' + inputDate"
          :style="{ color: 'white', backgroundColor: 'gray', height: $config_styles.HeightInput }" class="btn-date" />
        <DxButton :text="'지 ' + paymentDate"
          :style="{ color: 'white', backgroundColor: 'black', height: $config_styles.HeightInput }" class="btn-date" />
        <ProcessStatus v-model:value-status="statusParam.status" :disabled="statusParam.status > 20 || !compareForm()"
          @checkConfirm="mutateChangeStatus(statusParam)" noOptionNoInput />
      </a-col>
      <a-col style="display: inline-flex; align-items: center">
        <DxButton class="ml-4" icon="plus" @click="openAddNewModal" :disabled="!hasDataSource || isExpiredStatus" />
        <DxButton class="ml-3" @click="onDeleteItem" :disabled="!hasDataSource || isExpiredStatus || isNewRowPA720">
          <img style="width: 17px" src="@/assets/images/icon_delete.png" alt="" />
        </DxButton>
        <DxButton class="ml-4 d-flex" style="cursor: pointer" @click="modalHistory = true" :disabled="!hasDataSource">
          <a-tooltip placement="top">
            <template #title>기타소득자료 변경이력</template>
            <div class="text-center">
              <HistoryOutlined style="font-size: 16px" />
            </div>
          </a-tooltip>
        </DxButton>
        <DxButton class="ml-4" style="cursor: pointer" @click="modalHistoryStatus = true" :disabled="!hasDataSource">
          <a-tooltip placement="top">
            <template #title>기타소득 마감상태 변경이력</template>
            <div class="text-center">
              <img src="@/assets/images/icon_status_history.png" alt="" class="icon_status_history" />
            </div>
          </a-tooltip>
        </DxButton>
        <DxButton @click="editDay" class="ml-4 custom-button-checkbox"
          :disabled="!hasDataSource || isExpiredStatus || isNewRowPA720">
          <div class="d-flex-center">
            <checkbox-basic :valueCheckbox="true" disabled="true" />
            <span class="fz-12 pl-5">지급일변경</span>
          </div>
        </DxButton>
        <div class="custom-select-tab ml-4">
          <DxButton class="button-open-tab" @click="openTab({ name: '기타소득자등록', url: '/pa-710', id: 'pa-710' })">
            기타소득자등록</DxButton>
        </div>
      </a-col>
    </a-row>
    <a-row class="content-btm" style="flex-flow: row nowrap">
      <a-col :class="{ 'ele-opacity': !compareForm(), 'col-tax': true }" class="custom-layout">
        <TaxPayInfo ref="taxPayRef" :dataCallTableDetail="processKeyPA720" @editTax="editTax" :isFirstRun="isFirstRun"
          :changeFommDone="changeFommDone" :saveToNewRow="saveToNewRow" :compareType="compareType"
          :compareForm="compareForm" />
      </a-col>
      <a-col :span="11" class="custom-layout form-tax">
        <FormTaxPayInfo ref="formTaxRef" :key="formKey" :editTax="editTaxParam" :isLoadNewForm="isLoadNewForm"
          :hasDataSource="hasDataSource" @onFormDone="onFormDone" @subValidate="subValidate"
          :addNewIncomeExtra="processKeyPA720.processKey" :isExpiredStatus="isExpiredStatus" />
      </a-col>
    </a-row>
  </div>

  <DeletePopup @delDone="onDelDone" :modalStatus="modalDelete" @closePopup="modalDelete = false"
    :data="deleteIncomeExtrasParam" />
  <HistoryPopup :modalStatus="modalHistory" @closePopup="modalHistory = false" :data="processKeyPA720.processKey"
    title="변경이력" typeHistory="pa-720" />
  <HistoryPopup :modalStatus="modalHistoryStatus" @closePopup="modalHistoryStatus = false"
    :data="processKeyPA720.processKey" title="업무상태 변경이력" typeHistory="pa-720-status" />
  <EditPopup :modalStatus="modalEdit" @closePopup="onCloseEditDay" :data="dayEditArr" />
  <CopyMonth :modalStatus="modalCopy" :month="dataModalCopy" @closePopup="onCloseCopy" @addMonthSuccess="addMonthSuccess"
    :dateType="dateType" />
  <PopupMessage :modalStatus="rowChangeStatus" @closePopup="rowChangeStatus = false" :typeModal="'confirm'"
    :title="titleModalConfirm" :content="''" :cancelText="'아니요 '" :okText="'네 '" @checkConfirm="onRowChangeComfirm"
    :isConfirmIcon="false" />
</template>
<script lang="ts">
import { ref, defineComponent, watch, computed, reactive } from 'vue';
import DxButton from 'devextreme-vue/button';
import { useStore } from 'vuex';
import { useQuery, useMutation } from '@vue/apollo-composable';
import { companyId, openTab, startYearMonth } from '@/helpers/commonFunction';
import { DxDataGrid, DxColumn, DxScrolling, DxMasterDetail } from 'devextreme-vue/data-grid';
import queries from '@/graphql/queries/PA/PA7/PA720/index';
import mutations from '@/graphql/mutations/PA/PA7/PA720/index';
import DeletePopup from './components/Popup/DeletePopup.vue';
import EditPopup from './components/Popup/EditPopup.vue';
import TaxPayInfo from './components/TaxPayInfo.vue';
import FormTaxPayInfo from './components/FormTaxPayInfo.vue';
import CopyMonth from './components/Popup/CopyMonth.vue';
import notification from '@/utils/notification';
import { HistoryOutlined } from '@ant-design/icons-vue';
import { Message } from '@/configs/enum';
import { formatMonth, toNumber } from './utils/index';
import queriesHolding from '@/graphql/queries/CM/CM130/index';
import dayjs from 'dayjs';
export default defineComponent({
  components: {
    DxMasterDetail,
    DxDataGrid,
    DxColumn,
    DxButton,
    DxScrolling,
    DeletePopup,
    EditPopup,
    TaxPayInfo,
    FormTaxPayInfo,
    HistoryOutlined,
    CopyMonth,
  },
  setup() {
    const store = useStore();
    const globalYear = ref<number>(parseInt(sessionStorage.getItem("paYear") ?? '0'));
    const { move_column, colomn_resize } = store.state.settings;
    const modalEdit = ref<boolean>(false);
    const modalHistory = ref<boolean>(false);
    const modalHistoryStatus = ref<boolean>(false);
    const processKeyPA720 = computed(() => store.getters['common/processKeyPA720']);
    // param in form to get data detail
    const editTaxParam = ref<any>({
      companyId: companyId,
      incomeId: 0,
      processKey: processKeyPA720.value.processKey
    });
    const changeFommDone = ref(1); // to refetch datasource
    const formTaxRef = ref(); // connect to form tax component
    const taxPayRef = ref(); // connect to table tax component
    store.commit('common/processKeyPA720', globalYear.value);
    const dataActionUtilsPA720 = computed(() => store.getters['common/dataActionUtilsPA720']);
    const messageDelNoItem = Message.getMessage('COMMON', '404').message;
    const messageUpdate = Message.getMessage('COMMON', '106').message;
    const titleModalConfirm = ref(Message.getMessage('COMMON', '501').message);
    const formKey = ref(0); // reset form to be not valid.
    const inputDate = computed(() => {
      return hasDataSource.value ? processKeyPA720.value.processKey?.imputedYear + '-' + formatMonth(processKeyPA720.value.processKey?.imputedMonth) : '';
    });
    const paymentDate = computed(() => {
      return hasDataSource.value ? processKeyPA720.value.processKey?.paymentYear + '-' + formatMonth(processKeyPA720.value.processKey?.paymentMonth) : '';
    });

    // ------------------------DATA COMMON ------------------------

    const savePA710 = computed(() => store.state.common.savePA710);
    const getEmployeeExtrasParams = reactive({
      companyId,
      imputedYear: globalYear,
    });
    store.dispatch('common/employSelect', getEmployeeExtrasParams)
    watch(savePA710, () => {
      store.dispatch('common/employSelect', getEmployeeExtrasParams)
    })

    // =========================FUNCTIONS COMMON =========================

    const changedDataS = () => {
      refetchIncomeProcessExtras();
      isFirstRun.value = true;
      taxPayRef.value.firsTimeRow = true;
    };

    // =======================get incomeProcessExtras data-source ================================

    const incomeExtras = ref<any>([]);
    const incomeProcessExtrasParam = reactive({
      companyId: companyId,
      imputedYear: globalYear.value,
    });
    let dataSource = ref<any>([
      {
        globalYear: globalYear.value,
      },
    ]);
    const isFirstRun = ref<boolean>(true);
    const hasDataSource = ref<boolean>(false);
    const {
      refetch: refetchIncomeProcessExtras,
      loading: loadingIncomeProcessExtras,
      result: resultIncomeProcessExtras,
    } = useQuery(queries.getIncomeProcessExtras, incomeProcessExtrasParam, () => ({
      fetchPolicy: 'no-cache',
    }));
    watch(resultIncomeProcessExtras, (newVal: any) => {
      let responeData = newVal?.getIncomeProcessExtras || [];
      dataSource.value = [
        {
          globalYear: globalYear.value,
        },
      ];
      incomeExtras.value = [
        { id: 1, name: '인원' },
        { id: 2, name: '지급액' },
        { id: 3, name: '소득세' },
        { id: 4, name: '지방소득세' },
        { id: 5, name: '공제총액' },
        { id: 6, name: '차인지급액' },
      ];
      if (responeData?.length > 0) {
        dataSource.value[0].hasData = true;
        responeData.forEach((val: any) => {
          let dataAdd = {
            imputedMonth: val.imputedMonth,
            imputedYear: val.imputedYear,
            paymentYear: val.paymentYear,
            paymentMonth: val.paymentMonth,
          };
          incomeExtras.value[0]['month' + val.imputedMonth] = {
            value: toNumber(val?.employeeStat?.employeeCount + val?.employeeStat?.retireEmployeeCount)?.toLocaleString('en-US', { currency: 'VND' }),
            ...dataAdd,
          };
          incomeExtras.value[1]['month' + val?.imputedMonth] = {
            value: val?.incomeStat?.paymentAmount?.toLocaleString('en-US', {
              currency: 'VND',
            }),
            ...dataAdd,
          };
          incomeExtras.value[2]['month' + val?.imputedMonth] = {
            value: val?.incomeStat?.withholdingIncomeTax?.toLocaleString('en-US', {
              currency: 'VND',
            }),
            ...dataAdd,
          };
          incomeExtras.value[3]['month' + val?.imputedMonth] = {
            value: val?.incomeStat?.withholdingLocalIncomeTax?.toLocaleString('en-US', { currency: 'VND' }),
            ...dataAdd,
          };
          incomeExtras.value[4]['month' + val?.imputedMonth] = {
            value: toNumber(val?.incomeStat?.withholdingIncomeTax + val?.incomeStat?.withholdingLocalIncomeTax).toLocaleString('en-US', {
              currency: 'VND',
            }),
            ...dataAdd,
          };
          incomeExtras.value[5]['month' + val?.imputedMonth] = {
            value: val?.incomeStat?.actualPayment?.toLocaleString('en-US', {
              currency: 'VND',
            }),
            ...dataAdd,
          };
          dataSource.value[0]['month_' + val.imputedMonth] = val;
        });
      }
      hasDataSource.value = responeData.length > 0;
      // auto call api of current month or  month have just been created .
      if (isFirstRun.value) {
        if (dataSource.value[0]['month_' + processKeyPA720.value.processKey.imputedMonth]) {
          showDetailSelected(dataSource.value[0]['month_' + `${processKeyPA720.value.processKey.imputedMonth}`]);
        } else {
          hasDataSource.value = false;
          showDetailSelected({
            imputedMonth: processKeyPA720.value.processKey.imputedMonth,
            imputedYear: globalYear.value,
            paymentMonth: processKeyPA720.value.processKey.imputedMonth,
            paymentYear: globalYear.value,
          });
        }
        isFirstRun.value = false;
        return;
      }
    });

    // ======================= after change data ==================================

    // status after createing or editing a tax.
    const onFormDone = (emit: Boolean) => {
      if (emit) {
        if (isClickMonthDiff.value) {
          refetchIncomeProcessExtras();
        }
        if (!isClickMonthDiff.value) {
          changeFommDone.value++;
        }
        formTaxRef.value.isEdit = true;
      }
      onSubmit();
    };
    watch(changeFommDone, () => {
      refetchIncomeProcessExtras();
    });

    // ======================= track change of form ================================

    const formPA720 = computed(() => store.getters['common/formPA720']);
    const formEditPA720 = computed(() => store.getters['common/formEditPA720']);
    const isNewRowPA720 = computed(() => store.state.common.isNewRowPA720);
    //2 is row to be clicked. 1 is add button to be clicked. 3 is add button click and save by itself.
    const compareType = ref(1);
    const compareForm = () => {
      let { employee, actualPayment, incomePayment, ...obj } = formPA720.value.input;
      let { employee: e1, actualPayment: e2, incomePayment: e3, ...objEdit } = formEditPA720.value.input;
      return JSON.stringify(obj) == JSON.stringify(objEdit);
    };
    //function common
    const resetForm = async () => {
      formKey.value++;
      store.commit('common/formPA720', dataActionUtilsPA720.value);
      store.commit('common/formEditPA720', dataActionUtilsPA720.value);
    };
    const addNewRow = async () => {
      await resetForm();
      store.state.common.isNewRowPA720 = true;
      compareType.value = 1;
      formTaxRef.value.isEdit = false;
      taxPayRef.value.dataSourceDetail = taxPayRef.value.dataSourceDetail.concat(formPA720.value.input);
      taxPayRef.value.focusedRowKey = formPA720.value.input.incomeId;
      setTimeout(() => {
        store.commit('common/selectedRowKeysPA720', formPA720.value.input.incomeId);
      }, 10)
      editTaxParam.value.incomeId = formPA720.value.input.incomeId;
    };
    // save and open a new row
    const saveToNewRow = () => {
      store.state.common.isNewRowPA720 = true;
      compareType.value = 1;
      formTaxRef.value.isEdit = false;
      store.commit('common/formPA720', dataActionUtilsPA720.value);
      store.commit('common/formEditPA720', formPA720.value);
      formKey.value++;
    }
    const delNewRow = () => {
      taxPayRef.value.dataSourceDetail = taxPayRef.value.dataSourceDetail.splice(0, taxPayRef.value.dataSourceDetail?.length - 1);
      store.state.common.isNewRowPA720 = false;
      compareType.value = 2;
    };
    //on add row
    const rowChangeStatus = ref<Boolean>(false);
    // click add button 
    const openAddNewModal = async () => {
      compareType.value = 3;
      if (isNewRowPA720.value) {
        if (!compareForm()) {
          rowChangeStatus.value = true;
          return;
        }
        return;
      }
      if (!compareForm()) {
        rowChangeStatus.value = true;
        return;
      }
      addNewRow();
      return;
    };
    // handle when it has confirm result.
    const onRowChangeComfirm = async (ok: boolean) => {
      if (ok) {
        let ele = document.getElementById('pa720-save-js') as HTMLInputElement;
        ele.click();
      } else {
        taxPayRef.value.removeHoverRowKey();
        if (isClickMonthDiff.value) {
          onChangeMonth(changeMonthDataFake.value);
          isClickMonthDiff.value = false;
          return;
        }
        if (isClickEditDiff.value) {
          onEditItem();
          isClickEditDiff.value = false;
          return;
        }
        if (isClickAddMonthDiff.value) {
          addMonth(changeMonthDataFake.value);
          isClickAddMonthDiff.value = false;
          return;
        }
        if (isNewRowPA720.value) {
          taxPayRef.value.dataSourceDetail = taxPayRef.value.dataSourceDetail.splice(0, taxPayRef.value?.dataSourceDetail.length - 1);
          if (compareType.value == 1) {
            addNewRow();
            taxPayRef.value.focusedRowKey = formPA720.value.input.incomeId;
            store.commit('common/selectedRowKeysPA720', formPA720.value.input.incomeId);
            return;
          }
        }
        if (compareType.value === 1 || compareType.value == 3) {
          addNewRow();
          return;
        }
        taxPayRef.value.focusedRowKey = editTaxParamFake.value.incomeId;
        store.commit('common/selectedRowKeysPA720', editTaxParamFake.value.incomeId);
        editTaxParam.value.incomeId = editTaxParamFake.value.incomeId;
        store.state.common.isNewRowPA720 = false;
        compareType.value = 2;
      }
    };
    // enable load form when row change
    const isLoadNewForm = ref(false);
    const editTaxParamFake = ref();
    const editTax = async (emit: any, firsTimeRow: boolean) => {
      compareType.value = 2;
      if (!emit.incomeId) {
        resetForm();
        formTaxRef.value.isEdit = false;
        return;
      }
      editTaxParamFake.value = emit;
      if (firsTimeRow) {
        formTaxRef.value.isEdit = true;
        editTaxParam.value = emit;
        store.commit('common/selectedRowKeysPA720', emit.incomeId);
        return;
      }
      if (isNewRowPA720.value) {
        if (compareForm()) {
          delNewRow();
          taxPayRef.value.focusedRowKey = emit.incomeId;
          store.commit('common/selectedRowKeysPA720', emit.incomeId);
          editTaxParam.value = emit;
          formTaxRef.value.isEdit = true;
          return;
        }
        rowChangeStatus.value = true;
        return;
      }
      if (!compareForm()) {
        rowChangeStatus.value = true;
        return;
      } else {
        formTaxRef.value.isEdit = true;
        editTaxParam.value = emit;
        store.commit('common/selectedRowKeysPA720', emit.incomeId);
      }
    };

    //-----------------------submit form-------------------------------------

    const isErrorFormPA720 = computed(() => store.getters['common/isErrorFormPA720']);
    const onSubmit = () => {
      if (isErrorFormPA720.value) {
        subValidate()
      } else {
        if (compareType.value == 3) return;
        if (!store.state.common.isClickEditDiffPA720) {
          store.commit('common/selectedRowKeysPA720', compareType.value == 1 ? formPA720.value.input?.incomeId : editTaxParamFake.value.incomeId);
        }
        let incomeId = compareType.value == 1 ? formPA720.value.input.incomeId : editTaxParamFake.value.incomeId;
        editTaxParam.value = {
          ...editTaxParam.value,
          processKey: processKeyPA720.value.processKey,
          incomeId
        }
        taxPayRef.value.focusedRowKey = compareType.value == 1 ? formPA720.value.input?.incomeId : editTaxParamFake.value.incomeId;
        store.state.common.isNewRowPA720 = false;
        if (isClickMonthDiff.value) {
          onChangeMonth(changeMonthDataFake.value);
          isClickMonthDiff.value = false;
          return;
        }
        if (isClickEditDiff.value) {
          onEditItem();
          isClickEditDiff.value = false;
          return;
        }
        if (isClickAddMonthDiff.value) {
          addMonth(changeMonthDataFake.value);
          isClickAddMonthDiff.value = false;
          return;
        }
      }
    };
    // when submit form is valid
    const subValidate = () => {
      monthHover.value = 0;
      // taxPayRef.value.removeHoverRowKey();
      isClickEditDiff.value = false;
      isClickMonthDiff.value = false;
      isClickAddMonthDiff.value = false;
      taxPayRef.value.focusedRowKey = formPA720.value.input.incomeId;
      store.commit('common/selectedRowKeysPA720', formPA720.value.input.incomeId);
      editTaxParamFake.value = editTaxParam.value;
      compareType.value = 1;
    }

    // -----------------change income process extra status------------------------

    const statusParam = ref<any>({ status: 10 });
    const { mutate: mutateChangeStatus, onDone: onDoneChangeStatus, onError: onErrorChangeStatus } = useMutation(mutations.changeIncomeProcessExtraStatus);
    onDoneChangeStatus(() => {
      notification('success', messageUpdate);
      refetchIncomeProcessExtras();
    });
    onErrorChangeStatus((res: any) => {
      notification('error', res.message);
    })
    //check to disable all input
    const isExpiredStatus = computed(() => statusParam.value.status > 10)

    // -------------------- Delete item in tax table --------------------

    const modalDelete = ref<boolean>(false);
    const deleteIncomeExtrasParam = ref<any>({});
    const onDeleteItem = () => {
      deleteIncomeExtrasParam.value = {
        ...processKeyPA720.value,
        incomeIds: taxPayRef.value.incomeIdDels,
      };
      if (deleteIncomeExtrasParam.value?.incomeIds.length > 0) {
        modalDelete.value = true;
      } else {
        notification('warning', messageDelNoItem);
      }
    };
    const onDelDone = () => {
      changedDataS();
      store.commit('common/formEditPA720', formPA720.value);
    };

    // -------------------- Edit item in tax table --------------------

    const isClickEditDiff = ref(false);
    const dayEditArr = ref<any>([]);
    // check when editting, is data changed?
    const editDay = () => {
      store.state.common.isClickEditDiffPA720 = true;
      if (!compareForm()) {
        compareType.value = 1;
        rowChangeStatus.value = true;
        isClickEditDiff.value = true;
        return;
      }
      onEditItem();
    };
    const onEditItem = () => {
      if (taxPayRef.value?.paymentData.length > 0) {
        modalEdit.value = true;
        dayEditArr.value = taxPayRef.value.paymentData;
        store.state.common.isClickEditDiffPA720 = true;
      } else {
        notification('warning', messageDelNoItem);
      }
    }
    const onCloseEditDay = (emit: any) => {
      if (emit.length > 0) {
        store.commit('common/formEditPA720', formPA720.value);
        changeFommDone.value++;
        formTaxRef.value.incomeExtraParam.incomeId = emit[0];
        formTaxRef.value.triggerIncomeExtra = true;
        taxPayRef.value.selectRow(emit);
        taxPayRef.value.focusedRowKey = emit[0];
      } else {
        store.state.common.isClickEditDiffPA720 = false;
      }
      modalEdit.value = false;
    };

    // -------------------Add data in month---------------------

    const modalCopy = ref<boolean>(false);
    const dataModalCopy = ref<number>(1);
    const isClickAddMonthDiff = ref(false);
    const addMonth = (val: any) => {  // action add month when data is saved
      modalCopy.value = true;
      dataModalCopy.value = val;
      dataQuery.value.imputedYear = globalYear.value;
      configTrigger.value = true;
      refetchConfig();
    }
    const onAddMonth = (val: number) => {
      monthHover.value = val;
      if (!compareForm()) {
        compareType.value = 1;
        rowChangeStatus.value = true;
        isClickAddMonthDiff.value = true;
        changeMonthDataFake.value = val;
        return;
      }
      addMonth(val);
    };
    // when selected month in the copyMonth cpn.
    const addMonthSuccess = (emit: any) => {
      resetForm();
      dataSource.value[0]['month_' + emit.imputedMonth] = emit;
      hasDataSource.value = true;
      month.value = emit.imputedMonth;
      statusParam.value = { ...processKeyPA720.value, status: 10 };
      formTaxRef.value.isEdit = false;
      changeMonthDataFake.value = { imputedMonth: 0 };
    };
    // close copy modal. when emitVal is true it means that the form has been saved sucessfully.
    const onCloseCopy = (emitVal: any) => {
      if (emitVal) {
        changedDataS();
      } else {
        modalCopy.value = false;
        monthHover.value = 0;
        isClickAddMonthDiff.value = false;
      }
    }
    const disableAddMonth = (val: any) => {
      let date = dayjs(globalYear.value + '' + val);
      let dateToCompare = dayjs(`${startYearMonth}`, 'YYYYMM')
      return date.isBefore(dateToCompare);
    }

    // -------------------------click month in table top--------------

    const month = ref<number>(0); //active tab
    const changeMonthDataFake = ref();
    const isClickMonthDiff = ref(false);
    const onChangeMonth = (obj: any) => {
      if (!isFirstRun.value) {
        hasDataSource.value = true;
      }
      if (obj) {
        taxPayRef.value.firsTimeRow = true;
        let datObj = {
          imputedYear: obj?.imputedYear,
          imputedMonth: obj?.imputedMonth,
          paymentYear: obj?.paymentYear,
          paymentMonth: obj?.paymentMonth,
        };
        store.state.common.processKeyPA720.processKey = datObj;
        statusParam.value = { ...processKeyPA720.value, status: obj.status };
        month.value = obj.imputedMonth;
        store.state.common.isNewRowPA720 = false;
        dataQuery.value.imputedYear = globalYear.value;
        configTrigger.value = true;
        refetchConfig();
      }
      monthHover.value = 0;
    }
    const showDetailSelected = (obj: any) => {
      if (compareForm()) {
        onChangeMonth(obj);
      } else {
        compareType.value = 1;
        rowChangeStatus.value = true;
        changeMonthDataFake.value = obj;
        isClickMonthDiff.value = true;
        monthHover.value = obj.imputedMonth;
      }
    };

    //-----------get config to check default date type in copy month----------------

    const configTrigger = ref(false);
    const dateType = ref<number>(1);
    const dataQuery = ref({ companyId: companyId, imputedYear: globalYear.value });
    const { result: resultConfig, refetch: refetchConfig, onError: onErrorConfig } = useQuery(queriesHolding.getWithholdingConfig, dataQuery, () => ({
      enabled: configTrigger.value,
      fetchPolicy: 'no-cache',
    }));
    onErrorConfig(() => {
      configTrigger.value = false;
    })
    watch(resultConfig, (newVal) => {
      if (newVal) {
        const data = newVal.getWithholdingConfig;
        dateType.value = data.paymentType;
        store.state.common.paymentDayPA720 = data.paymentDay;
        store.state.common.paymentDayDefaultPA720 = data.paymentDay;
        configTrigger.value = false;
      }
    });

    //-----------------------------hover column-----------------------------
    const monthHover = ref(0);
    const customColumnClass = (val: any) => {
      return val == month.value ? 'column-focus' : monthHover.value == val ? ' td-hover-custom' : '';
    };

    return {
      statusParam,
      loadingIncomeProcessExtras,
      move_column,
      colomn_resize,
      modalDelete,
      modalEdit,
      globalYear,
      incomeExtras,
      dataSource,
      processKeyPA720,
      editTaxParam,
      changeFommDone,
      formTaxRef,
      taxPayRef,
      deleteIncomeExtrasParam,
      dayEditArr,
      modalHistory,
      modalHistoryStatus,
      modalCopy,
      dataModalCopy,
      isFirstRun,
      month,
      isLoadNewForm,
      titleModalConfirm,
      hasDataSource,
      paymentDate,
      inputDate,
      formPA720,
      rowChangeStatus,
      onDeleteItem,
      editDay,
      showDetailSelected,
      editTax,
      onFormDone,
      onAddMonth,
      mutateChangeStatus,
      onCloseEditDay,
      addMonthSuccess,
      resetForm,
      openTab,
      openAddNewModal,
      onRowChangeComfirm,
      onDelDone,
      isExpiredStatus,
      compareForm,
      subValidate,
      isNewRowPA720,
      compareType,
      editTaxParamFake,
      formEditPA720,
      dataActionUtilsPA720,
      formKey,
      saveToNewRow,
      dateType,
      changeMonthDataFake,
      onCloseCopy,
      customColumnClass,
      isClickAddMonthDiff, isClickMonthDiff,
      disableAddMonth,
    };
  },
});
</script> 
<style lang="scss" scoped src="./style/style.scss" ></style>
