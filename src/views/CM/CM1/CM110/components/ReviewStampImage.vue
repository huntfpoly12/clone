<template>
    <div>
        <a-modal :visible="modalStatus" title="직인자동생성" @cancel="setModalVisible()" :mask-closable="false" width="400px">
            <div class="stamp-image-content">
                <div class="stamp-child">
                    <div class="stamp-text-note">
                        <div style="font-size: 16px;margin-right: 5px;">
                            <InfoCircleFilled />
                        </div>
                        <div>
                            <a-typography-text>
                                직인에 인쇄될 상호를 입력하신 후 <br />미리보기 버튼을
                                누르세요.
                            </a-typography-text>
                        </div>
                    </div>
                </div>
                <div class="stamp-child">
                    <a-input-group compact>
                        <a-input v-model:value="signature" placeholder="2~15자 (특수문자불가)"
                            style="width: calc(100% - 128px)" @change="validateCharacter" :maxlength="15" />
                        <a-button type="primary" :disabled="disabledBtnPreview"
                            @click="createMyCompanyAutoGeneratedSeal">미리보기</a-button>
                    </a-input-group>
                </div>
                <div class="stamp-child">
                    <a-image :width="312" :src="previewImage" :preview="false"
                        fallback="data:image/png;base64,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" />
                </div>
                <div class="stamp-child">
                    <a-button type="primary" class="btn-stamp" @click="handOk">저장</a-button>
                </div>
            </div>
            <template #footer> </template>
        </a-modal>
    </div>
</template>
<script lang="ts">
import { ref, defineComponent, watch } from "vue";
import { InfoCircleFilled } from "@ant-design/icons-vue";
import { useMutation, useQuery } from "@vue/apollo-composable";
import mutations from "../../../../../graphql/mutations/CM/CM110/index";
import queries from "../../../../../graphql/queries/CM/CM110/index"
function getBase64(file: File) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = (error) => reject(error);
    });
}
export default defineComponent({
    props: ["modalStatus", "data", "previewImageCall"],
    components: {
        InfoCircleFilled,
    },
    setup(props, { emit }) {
        let previewImage: any = ref("");
        let signature = ref("");
        let disabledBtnPreview = ref(true);
        watch(() => props.modalStatus, async (currentValue, oldValue) => {
            if (typeof currentValue !== "undefined" && props.data) {
                previewImage.value = await getBase64(props.data.file.originFileObj);
            }
        });
        const setModalVisible = () => {
            emit("closePopup", false);
            previewImage.value = "";
            signature.value = '';
        };
        const validateCharacter = (e: any) => {
            var format = /[ `!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/;
            let countLength = signature.value.length;
            if (2 <= countLength && countLength < 16 && !format.test(signature.value)) {
                disabledBtnPreview.value = false;
            } else {
                signature.value = e.target.value.replace(/[ `!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/g, '')
                disabledBtnPreview.value = true;
            }
        };
        const {
            mutate: getSeal,
            loading: loadingUpdate,
            onDone: onDoneSeal,
            onError: onErrSeal
        } = useMutation(mutations.createMyCompanyAutoGeneratedSeal);
        onDoneSeal(e => {})
        let triggers = ref<boolean>(false);
        const dataCall = ref({
            name: signature
        })
        const { refetch: refetchData, loading, error, onResult } = useQuery(queries.getSeal, dataCall.value, () => ({ enabled: triggers.value, fetchPolicy: "no-cache", }))
        let sealData = ref('')
        onResult(e => {
            previewImage.value = 'data:image/png;base64,' + e.data.getMyCompanyAutoGeneratedSeal.seal
            sealData.value = e.data.getMyCompanyAutoGeneratedSeal.seal
        })
        const createMyCompanyAutoGeneratedSeal = () => {
            refetchData()
            triggers.value = true
        }
        const handOk = () => {
            emit("urlSeal" , sealData.value)
            emit("closePopup", false);
        }
        return {
            setModalVisible,
            previewImage,
            signature,
            validateCharacter,
            disabledBtnPreview,
            createMyCompanyAutoGeneratedSeal,
            handOk
        };
    },
});
</script> 
<style scoped>
.stamp-image-content {
    text-align: center;
}
.stamp-child {
    margin-bottom: 10px;
}
.btn-stamp {
    width: 160px;
}
.stamp-text-note {
    text-align: left;
    margin-left: 3px;
    display: flex;
}
</style>