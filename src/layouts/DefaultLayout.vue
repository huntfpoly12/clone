<template>
  <a-layout>
    <a-layout-header class="header">
      <div class="nav-logo">
        <a @click="addMenuTab('')"><img src="../assets/images/logo.png" /></a>
      </div>
      <div class="user-info" v-if="username">
        <FacilityBizTypeHeader />
        <year-header />
        <a-dropdown>
          <a class="ant-dropdown-link" @click.prevent>
            {{ username }}
            <DownOutlined />
          </a>
          <template #overlay>
            <a-menu>
              <a-menu-item>
                <router-link to="/change-password">비밀번호 변경</router-link>
              </a-menu-item>
              <a-menu-item>
                <p @click="logout">로그아웃</p>
              </a-menu-item>
            </a-menu>
          </template>
        </a-dropdown>
      </div>
    </a-layout-header>

    <a-layout-content>
      <div class="header-content">
        <div class="left">
          <a-button type="primary" @click="() => (collapsed = !collapsed)">
            <menu-unfold-outlined v-if="collapsed" class="trigger" />
            <menu-fold-outlined v-else class="trigger" />
          </a-button>

          <div class="wrap-search">
            <a-select
              v-model:value="selectedItems"
              :options=" menuData.map((item) => ({
                  value: item.id,
                  label: item.id + ' | ' + item.name,
                }))"
              show-search
              placeholder="메뉴를 입력해보세요"
              style="width: 180px"
              optionFilterProp="label"
              @change="addMenuTab"
            />
          </div>
        </div>
        <div class="right">
          <nav class="nav-tabs" v-if="menuTab.length > 0">
            <!-- hide or show scroll arrows left when page width is exceeded -->
            <caret-left-outlined class="arrow-left"  v-if="isArrowScroll"  @click="tabLeft"/>
            <ul ref="scroll_container" class="list-menu-tab">
              <li
                v-for="(item, index) in menuTab"
                :class="activeTab.id === item.id ? 'active' : ''"
                :key="index"
                @click.self="changeActiveTab(item)"
              >
                {{ item.name }}
                <close-circle-filled
                  @click="removeItemTab(index)"
                  :style="{
                    marginLeft: '2px',
                    color: activeTab.id === item.id ? 'red' : '#888',
                  }"
                />
              </li>
            </ul>
            <!-- hide or show scroll arrows right when page width is exceeded -->
            <caret-right-outlined v-if="isArrowScroll" class="arrow-right"  @click="tabRight" />
          </nav>

        </div>
      </div>
      <a-layout>
        <a-layout-sider
          width="250"
          v-model:collapsed="collapsed"
          :trigger="null"
          collapsible
        >
          <a-menu
            v-model:selectedKeys="selectedKeys"
            theme="dark"
            mode="inline"
            :inline-collapsed="false"
            :open-keys="openKeys"
            @openChange="onOpenChange"
          >
            <div v-for="menuItem in menuItems" :key="menuItem.id" v-check-permission:read="menuItem.roles">
              <a-sub-menu :key="menuItem.id" >
                <!-- list main menu lavel 0 -->
                <template #icon v-if="menuItem.icon">
                  <div id="icon-menu">
                    <i :class="menuItem.icon" class="dx-icon"></i>
                  </div>
                </template>
                <template #title>{{ menuItem.title }}</template>
                <!-- list sub menu level 1 -->
                <template v-for="itemLevel1 in menuItem.subMenus"  :key="'sub-level-1-'+itemLevel1.id">
                    <div  v-check-permission:read="itemLevel1?.roles" class="menuuuuu">
                      <a-menu-item v-if="!itemLevel1?.subMenus"
                                   :class="[
                          itemLevel1.id === activeTab.id
                            ? 'ant-menu-item-selected-active'
                          : '',
                          itemLevel1.url == '#' ? 'not-done' : ''
                            ]
                          "
                                   @click.enter="addMenuTab(itemLevel1.id)"
                      >
                        <router-link :to="itemLevel1.url" >{{ itemLevel1.title }}</router-link>
                      </a-menu-item>
                      <a-sub-menu v-else  :title="itemLevel1.title" :key="itemLevel1.id">
                        <!-- list sub menu level 2 if have subMenus -->
                        <template v-for="itemLevel2 in itemLevel1.subMenus"  :key="'sub-'+itemLevel2.id">
                          <div v-check-permission:read="itemLevel2?.roles">
                            <a-menu-item
                              v-if="!itemLevel2.hasOwnProperty('subMenus')"
                              :class="[
                            itemLevel2.id === activeTab.id
                              ? 'ant-menu-item-selected-active'
                            : '',
                            itemLevel2.url == '#' ? 'not-done' : ''
                              ]
                            "
                              @click.enter="addMenuTab(itemLevel2.id)"
                            >
                              <router-link :to="itemLevel2.url" >{{ itemLevel2.title }}</router-link>
                            </a-menu-item>
                            <a-sub-menu v-else  :title="itemLevel2.title" :key="itemLevel2.id">
                              <a-menu-item
                                v-for="subMenu1 in itemLevel2.subMenus"
                                :key="subMenu1.id"
                                :class="[
                            subMenu1.id === activeTab.id
                              ? 'ant-menu-item-selected-active'
                            : '',
                            subMenu1.url == '#' ? 'not-done' : ''
                              ]
                            "
                                @click.enter="addMenuTab(subMenu1.id)"
                              >
                                <router-link :to="subMenu1.url" >{{ subMenu1.title }} {{ subMenu1.id }} </router-link>
                              </a-menu-item>
                            </a-sub-menu>
                          </div>
                        </template>
                      </a-sub-menu>
                    </div>
                  </template>
              </a-sub-menu>
            </div>
          </a-menu>
        </a-layout-sider>
        <a-layout>
          <a-layout-content
            :style="{ background: '#fff', margin: 0, minHeight: '280px' }"
          >
            <div class="main-content">
              <template v-if="activeTab">
                <keep-alive :exclude="cachedTab">
                  <component :is="currentComponent" />
                </keep-alive>
              </template>
              <template v-else>
                <keep-alive>
                  <component v-bind:is="'Example'" />
                </keep-alive>
              </template>
            </div>
          </a-layout-content>
        </a-layout>
      </a-layout>
    </a-layout-content>
  </a-layout>
</template>
<script>
import { defineComponent, ref, watch, computed, onMounted } from "vue";
import {  useRouter } from 'vue-router'
import { useStore } from 'vuex';
import menuTree from "./menuTree";
import menuData from "./menuData";
import { DownOutlined } from '@ant-design/icons-vue';

import {
  BF310,
  BF320,
  BF330,
  BF340,
  BF210,
  BF530,
  BF610,
  BF620,
  BF640,
  BF650,
  BF630,
  BF220,
  CM110,
  CM121,
  CM130,
  PA110,
  PA120,
  PA210,
  PA220,
  PA230,
  PA430,
  PA420,
  PA410,
  PA610,
  PA620,
  PA630,
  PA530,
  PA520,
  PA510,
  PA710,
  PA730,
  PA720,
  PA810,
  PA820,
  PA830,
  PA840,
  PA860,
  PA870,
  PA880,
  AC110,
  AC120,
  AC130,
  AC510,
  AC530,
  AC540,
  AC550,
  AC560,
  AC570,
  AC590,
  AC580,
  AC610,
  AC620,
  AC630,
  AC520,
  Test,
  Example,
} from "./screenComponents";

import {
  MenuFoldOutlined,
  MenuUnfoldOutlined,
  MailOutlined,
  PrinterOutlined,
  DeleteOutlined,
  SearchOutlined,
  SaveOutlined,
  CloseCircleFilled,
  CaretLeftOutlined,
  CaretRightOutlined
} from "@ant-design/icons-vue";
import {AdminScreenRole, getJwtObject, ScreenRole} from '@bankda/jangbuda-common';
import { companyId } from "@/helpers/commonFunction";
import dayjs from "dayjs";;
export default defineComponent({
  name: `LayoutDefault`,
  data() {
    return {
      styles: {
        main: this.$config_styles.Main,
        sub: this.$config_styles.Sub,
      },
    };
  },
  components: {
    DownOutlined,
    BF310,
    BF320,
    BF330,
    BF340,
    BF210,
    BF530,
    BF610,
    BF620,
    BF640,
    BF650,
    BF630,
    BF220,
    CM110,
    CM121,
    CM130,
    PA110,
    PA120,
    PA210,
    PA220,
    PA230,
    PA430,
    PA420,
    PA410,
    PA610,
    PA620,
    PA630,
    PA530,
    PA520,
    PA510,
    PA710,
    PA720,
    PA730,
    PA810,
    PA820,
    PA830,
    PA840,
    PA860,
    PA870,
    PA880,
    AC110,
    AC120,
    AC130,
    AC510,
    AC530,
    AC540,
    AC550,
    AC560,
    AC570,
    AC590,
    AC580,
    AC610,
    AC620,
    AC630,
    AC520,
    Test,
    Example,
    MenuFoldOutlined,
    MenuUnfoldOutlined,
    MailOutlined,
    PrinterOutlined,
    DeleteOutlined,
    SearchOutlined,
    SaveOutlined,
    CloseCircleFilled,
    CaretLeftOutlined,
    CaretRightOutlined
  },
  created() {
    menuData.forEach((item) => {
      if (this.$route.fullPath.includes(item.id)) {
        // clear vuex value cachedTab
        this.$store.state.common.cachedTab.push(item.id.toUpperCase().replaceAll('-', ''))
        this.activeTab = item;
        this.$store.state.common.activeTab = item
        this.menuTab.push(item);
        return;
      } else if (
        this.$route.fullPath === "/dashboard/" ||
        this.$route.fullPath === "/dashboard"
      ) {
        this.activeTab = { name: "dashboard", url: "/dashboard", id: "" };
      }
    });

    if (
      this.$route.fullPath === "/dashboard/" ||
      this.$route.fullPath === "/dashboard"
    ) {
      this.activeTab = { name: "Dashboard", url: "/dashboard", id: "" };
      this.menuTab.push({ name: "Dashboard", url: "/dashboard", id: "" });
    }
  },
  watch: {
     activeTab: {
      handler(newValue, oldVal) {
         if (newValue) {
          if (newValue.id.includes("bf-1")) {
            this.openKeys = ["bf-000", "bf-100"];
          }
          if (newValue.id.includes("bf-2")) {
            this.openKeys = ["bf-000", "bf-200"];
          }
          if (newValue.id.includes("bf-3")) {
            this.openKeys = ["bf-000", "bf-300"];
          }
          if (newValue.id.includes("bf-4")) {
            this.openKeys = ["bf-000", "bf-400"];
          }
          if (newValue.id.includes("bf-5")) {
            this.openKeys = ["bf-000", "bf-500"];
          }
          if (newValue.id.includes("bf-6")) {
            this.openKeys = ["bf-000", "bf-600"];
          }
          if (newValue.id.includes("cm-1")) {
            this.openKeys = ["cm-100", "cm-120"];
          }
          if (newValue.id.includes("ac-1")) {
            this.openKeys = ["ac-000", "ac-100"];
          }
          if (newValue.id.includes("ac-2")) {
            this.openKeys = ["ac-000", "ac-200"];
          }
          if (newValue.id.includes("ac-3")) {
            this.openKeys = ["ac-000", "ac-300"];
          }
          if (newValue.id.includes("ac-4")) {
            this.openKeys = ["ac-000", "ac-400"];
          }
          if (newValue.id.includes("ac-5")) {
            this.openKeys = ["ac-000", "ac-500"];
          }
          if (newValue.id.includes("pa-1")) {
            this.openKeys = ["pa-000", "pa-100"];
          }
          if (newValue.id.includes("pa-2")) {
            this.openKeys = ["pa-000", "pa-200"];
          }
          if (newValue.id.includes("pa-3")) {
            this.openKeys = ["pa-000", "pa-300"];
          }
          if (newValue.id.includes("pa-4")) {
            this.openKeys = ["pa-000", "pa-400"];
          }
          if (newValue.id.includes("pa-5")) {
            this.openKeys = ["pa-000", "pa-500"];
          }
          if (newValue.id.includes("pa-6")) {
            this.openKeys = ["pa-000", "pa-600"];
          }
          if (newValue.id.includes("pa-7")) {
            this.openKeys = ["pa-000", "pa-700"];
          }
          if (newValue.id.includes("pa-8")) {
            this.openKeys = ["pa-000", "pa-800"];
          }
          if (newValue.id.includes("ac-6")) {
            this.openKeys = ["ac-000", "ac-600"];
          }
          if (newValue.id !== "#") {
            this.$router.push(`/dashboard/${newValue.id}`);
          }
        }
      },
      immediate: true,
    },
  },

  computed: {
    username() {
      if (sessionStorage.getItem("username")) {
        return sessionStorage.getItem("username");
      } else {
        return "";
      }
    },

    currentComponent() {
      if (this.activeTab.id === "bf-310") return 'BF310';
      if (this.activeTab.id === "bf-320") return 'BF320';
      if (this.activeTab.id === "bf-330") return 'BF330';
      if (this.activeTab.id === "bf-340") return 'BF340';
      if (this.activeTab.id === "bf-210") return 'BF210';
      if (this.activeTab.id === "bf-220") return 'BF220';
      if (this.activeTab.id === "bf-530") return 'BF530';
      if (this.activeTab.id === "bf-610") return 'BF610';
      if (this.activeTab.id === "bf-620") return 'BF620';
      if (this.activeTab.id === "bf-640") return 'BF640';
      if (this.activeTab.id === "bf-650") return 'BF650';
      if (this.activeTab.id === "bf-630") return 'BF630';
      if (this.activeTab.id === "cm-110") return 'CM110';
      if (this.activeTab.id === "cm-121") return 'CM121';
      if (this.activeTab.id === "cm-130") return 'CM130';
      if (this.activeTab.id === "pa-110") return 'PA110';
      if (this.activeTab.id === "pa-120") return 'PA120';
      if (this.activeTab.id === "pa-210") return 'PA210';
      if (this.activeTab.id === "pa-220") return 'PA220';
      if (this.activeTab.id === "pa-230") return 'PA230';
      if (this.activeTab.id === "pa-410") return 'PA410';
      if (this.activeTab.id === "pa-420") return 'PA420';
      if (this.activeTab.id === "pa-430") return 'PA430';
      if (this.activeTab.id === "pa-610") return 'PA610';
      if (this.activeTab.id === "pa-620") return 'PA620';
      if (this.activeTab.id === "pa-630") return 'PA630';
      if (this.activeTab.id === "pa-530") return 'PA530';
      if (this.activeTab.id === "pa-520") return 'PA520';
      if (this.activeTab.id === "pa-510") return 'PA510';
      if (this.activeTab.id === "pa-710") return 'PA710';
      if (this.activeTab.id === "pa-720") return 'PA720';
      if (this.activeTab.id === "pa-730") return 'PA730';
      if (this.activeTab.id === "pa-810") return 'PA810';
      if (this.activeTab.id === "pa-820") return 'PA820';
      if (this.activeTab.id === "pa-830") return 'PA830';
      if (this.activeTab.id === "pa-840") return 'PA840';
      if (this.activeTab.id === "pa-860") return 'PA860';
      if (this.activeTab.id === "pa-880") return 'PA880';
      if (this.activeTab.id === "pa-870") return 'PA870';
      if (this.activeTab.id === "ac-110") return 'AC110';
      if (this.activeTab.id === "ac-120") return 'AC120';
      if (this.activeTab.id === "ac-130") return 'AC130';
      if (this.activeTab.id === "ac-510") return 'AC510';
      if (this.activeTab.id === "ac-530") return 'AC530';
      if (this.activeTab.id === "ac-520") return 'AC520';
      if (this.activeTab.id === "ac-540") return 'AC540';
      if (this.activeTab.id === "ac-550") return 'AC550';
      if (this.activeTab.id === "ac-560") return 'AC560';
      if (this.activeTab.id === "ac-570") return 'AC570';
      if (this.activeTab.id === "ac-590") return 'AC590';
      if (this.activeTab.id === "ac-580") return 'AC580';
      if (this.activeTab.id === "ac-610") return 'AC610';
      if (this.activeTab.id === "ac-620") return 'AC620';
      if (this.activeTab.id === "ac-630") return 'AC630';
      if (this.activeTab.id === "example" || this.activeTab.id === "") return 'Example';
      return Test;
    },
  },
  setup() {
    const inputSearchText = ref("");
    const filteredResult =ref([]);
    const openKeys = ref([]);
    const rootSubmenuKeys = ref(["bf-000", "cm-100", "ac-000", "pa-000"]);
    const selectedKeys = ref([]);
    const state = ref(false);

    let menuItems = menuTree;
    const store = useStore();
    const router = useRouter()
    const collapsed = ref(false);
    const selectedItems = ref([]);
    const activeTab = ref();
    // cachedtab is used to handle exclude in the keep-alive tag
    const cachedTab = ref([]);
    const token = sessionStorage.getItem("token");
    const jwtObject = getJwtObject(token);
    onMounted(async() => {
      store.commit('auth/setTokenInfo',jwtObject)
     //get and set account subject
      let globalFacilityBizId = store.getters['settings/globalFacilityBizId']
      //await store.dispatch('settings/getAccountSubject',{ companyId: companyId, fiscalYear: Number(dayjs().year()),facilityBizType: globalFacilityBizId})
      // store.commit('auth/setTokenInfo',jwtObject)
    })
    /**
    * Check scroll tab if overflow
    */
    const scroll_container = ref(null);
    const isArrowScroll= ref(false);
    const checkOverflow = ()=> {
          isArrowScroll.value =  scroll_container.value.offsetWidth   < scroll_container.value.scrollWidth
    }
    const tabLeft = (e)=>{
       if(scroll_container.value.offsetWidth   < scroll_container.value.scrollWidth){
              scroll_container.value.scrollTo({
                left: scroll_container.value.scrollLeft -= 200,
                    behavior: 'smooth',
          }) ;
       }

    }
    const tabRight = (e)=>{
       if(scroll_container.value.offsetWidth   < scroll_container.value.scrollWidth){
          scroll_container.value.scrollTo({
            left: scroll_container.value.scrollLeft += 200,
            behavior: 'smooth',
          }) ;
       }
    }

    /**
     * init menuTab from vuex
     */
    let menuTab = ref(store.state.common.menuTab);

    const logout = ()=>{
      router.push("/login");
      location.reload();
      store.commit("auth/logout");
    }

    const onSearch  = (key)=>{
      state.value = true;
      filteredResult.value = [];
      inputSearchText.value = key;
      if (menuData?.length > 0) {

        menuData.forEach((val) => {
          const searchId = val.name.includes(key) || val.id.includes(key);
          if (searchId) {
            filteredResult.value.push(val);
          }
        });
      }
    }
    const toggleDropdown  = ()=>{
      state.value = !state.value;
    }

    const gotoDashboard = () => {
      activeTab.value = { name: "Dashboard", url: "/dashboard", id: "" };
      router.push("/dashboard");
      menuTab.value.push({ name: "Dashboard", url: "/dashboard", id: "" });
    }
    const addMenuTab = (itemId) => {
      if (itemId != '') {
        let itemNew = [];
        itemNew = menuData.find(item => item.id === itemId);
        if (itemNew.url == '#') {
          return
        }

        activeTab.value = menuData.find(item => item.id === itemId);
        store.state.common.activeTab = itemNew
        store.state.common.cachedTab.push(itemNew.id.toUpperCase().replaceAll('-', ''))
        //If the number of tabs exceeds 20, new tabs will not be added
        if (menuTab.value.length < 20 && !menuTab.value.includes(activeTab.value)) {
          menuTab.value.push(itemNew);
          selectedItems.value = [];
          checkOverflow()
        }
      // If you select the logo, it will add a dashboard tab object
      } else if (!menuTab.value.some(item => item.name === 'Dashboard')) {
        gotoDashboard()
      } else {
        activeTab.value = { name: "Dashboard", url: "/dashboard", id: "" };
      }
    }
    /**
     * event when click icon close one tab
     */
    const removeItemTab = (item) => {
      // clear vuex value cachedTab
      let tabName = menuTab.value[item].id.toUpperCase().replaceAll('-', '')
      store.state.common.cachedTab = store.state.common.cachedTab.filter((item) => item != tabName )

      menuTab.value.splice(item, 1);
      activeTab.value = menuTab.value.slice(-1)[0];
      store.state.common.activeTab = activeTab.value
      selectedItems.value = [];
      if (menuTab.value.length === 0) {
        gotoDashboard()
      }
      checkOverflow()
    }
    const changeActiveTab  = (item)=>{
      activeTab.value = item;
      if (menuTab.value.length === 0) {
        gotoDashboard()
      }
      store.state.common.activeTab =  activeTab.value
    }

    /**
     * monitor cachedtabs variable on vuex to blow cachedtab variable at component
     */
    watch(()=>store.state.common.cachedTab, (newValue)=>{
        cachedTab.value = newValue;
    }, { deep: true })
    const focusInput  = ()=>{
      state.value = false;
    }
    /**
     * monitor activeTab variable on vuex to blow activeTab variable at component
     */
    watch(()=>store.state.common.activeTab, (newValue)=>{
        activeTab.value = newValue;
    }, { deep: true })

    const onOpenChange = (opKeys) => {
      const latestOpenKey = opKeys.find(
        (key) => openKeys.value.indexOf(key) === -1
      );
      if (rootSubmenuKeys.value.indexOf(latestOpenKey) === -1) {
        if (latestOpenKey && latestOpenKey.includes("bf")) {
          openKeys.value = ["bf-000", latestOpenKey];
        } else if (latestOpenKey && latestOpenKey.includes("cm")) {
          openKeys.value = ["cm-100", latestOpenKey];
        } else if (latestOpenKey && latestOpenKey.includes("ac")) {
          openKeys.value = ["ac-000", latestOpenKey];
        } else if (latestOpenKey && latestOpenKey.includes("pa")) {
          openKeys.value = ["pa-000", latestOpenKey];
        }
      } else {
        openKeys.value = latestOpenKey ? [latestOpenKey] : [];
      }
    }
    return {
      logout,
      onSearch,
      toggleDropdown,
      addMenuTab,
      removeItemTab,
      changeActiveTab,
      focusInput,
      onOpenChange,
      menuItems,
      menuData,
      activeTab,
      menuTab,
      collapsed,
      selectedItems,
      selectedKeys,
      openKeys,
      scrollX,
      scroll_container,
      isArrowScroll,
      tabLeft,tabRight,cachedTab,store,
    }
  },
});
</script>
<style lang="scss" src="./style/style.scss">
.header-content {
  background: v-bind('styles.sub');
}

.ant-layout-header {
  background: v-bind('styles.main');
}

.not-done{
  color: red;
}
::v-deep .dx-datagrid .dx-row>td {
    padding: 5px;
}
</style>
